<template>
  <div class="wrapper">
    <div class="headings" :class="[activeClass]">
        <div class="nav-button" v-for="(item, index) in navItems" :key="item.title" :class="{'selected': selectedIdx === index && enabled && !focus}">
        <div class="focus_bg"></div>
        <span>{{item.title}}</span>
        </div>
    </div>
    <div class="scroll_mask" :class="[activeClass]" v-if="true"></div>
    <div class="content-wrapper">
      <div class="list" :style="translateY">
        <contentlist class="contentlist" @movefocus="movefocus" :active="enabled && focus === 1" :scroll="scroll" :translate="translate"></contentlist>
      </div>
    </div>
  </div>
</template>
<script>
import { mapGetters, mapState, mapMutations } from 'vuex';
// import drivers from '../common/drivers';
import Messages from '../../services/Messages';
import contentlist from './contentlist';

export default {
  name: 'homescreen',
  props: {
    enabled: {
      type: Boolean,
    },
  },
  mounted() {
    Messages.$on('button_down', this.handleKeyDown);
  },
  destroyed() {
    Messages.$off('button_down', this.handleKeyDown);
  },
  data() {
    return {
      translate: 0,
      scrollMask: false,
    };
  },
  computed: {
    ...mapGetters('home', {
      navItems: 'GET_NAVS',
      focus: 'HOME_FOCUS',
    }),
    ...mapState([
      'isRemoteEnabled',
    ]),
    ...mapState('home', [
      'selectedIdx',
      'speed',
      'listType',
      'panning',
      'showMore',
    ]),
    activeClass() {
      if (this.enabled) {
        return 'push-down';
      }
      return '';
    },
    translateY() {
      return { transform: `translateY(${((this.translate * 100) / window.innerWidth)}vw)` };
    },
  },
  methods: {
    movefocus(param) {
      if (param.from === 'content') {
        if (param.dir === 'up') {
          if (this.focus === 1) {
            this.$nextTick(() => {
              this.setfocus(0);
            });
          }
        }
      }
    },
    scroll(dir, delta) {
      if (dir === 'up') {
        this.translate += delta;
      } else if (dir === 'down') {
        this.translate -= delta;
      } else {
        this.translate = delta;
      }
    },
    ...mapMutations('home', {
      setnav: 'SET_NAV',
      setfocus: 'SET_HOME_FOCUS',
    }),
    setpanning(flag) {
      if (flag) {
        if (!this.anim) {
          const listEle = this.$el.querySelectorAll('.grid-templates');
          const toTranslate = listEle[listEle.length - 1].offsetTop;
          const el = this.$el.querySelector('.list');
          const time = (toTranslate / this.speed);
          this.anim = el.animate([
            { transform: 'translateY(0px)' },
            { transform: `translateY(-${(toTranslate * 100) / window.innerWidth}vw)` },
          ], {
            duration: time * 1000,
            fill: 'forwards',
          });
        }
        this.anim.play();
      } else {
        this.anim.pause();
      }
    },
    handleKeyDown(type) {
      if (!this.active && !this.enabled) return;
      switch (type) {
        case 'EXTRA':
          break;
        case 'RIGHT':
          if (this.focus === 0) {
            if (this.selectedIdx < this.navItems.length - 1) {
              this.setnav(this.selectedIdx + 1);
            }
          }
          break;
        case 'DOWN':
          this.setfocus(1);
          break;
        case 'LEFT':
          if (this.focus === 0) {
            if (this.selectedIdx > 0) {
              this.setnav(this.selectedIdx - 1);
            }
          }
          break;
        case 'UP':
          if (this.focus === 0) {
            this.$emit('movefocus', { dir: 'up', from: 'homescreen' });
          }
          break;
        case 'NINE':
          break;
        default:
          break;
      }
    },
  },
  watch: {
    selectedIdx() {
      if (this.anim) {
        this.anim.cancel();
        this.anim = null;
      }
    },
    panning() {
      if (this.showMore === 'partial') {
        if (this.anim) {
          if (this.anim.playState === 'paused') {
            this.anim.play();
          } else if (this.anim.playState === 'running') {
            this.anim.pause();
          } else {
            this.anim.play();
          }
        } else {
          this.setpanning(true);
        }
        // window.anim = this.anim;
      }
    },
    showMore(val) {
      if (val !== 'fullhome') {
        if (this.anim) {
          this.anim.cancel();
          this.anim = null;
        }
      }
      // if (val === 'partial' || val === 'fullhome') {
      //   this.setpanning(true);
      // }
    },
  },
  components: {
    contentlist,
  },
};
</script>
<style scoped lang="scss">
  @import '../../mixins/scss/main';
  .wrapper {
    position: relative;
    left: 0;
    width: 100%;
    height: auto;
    transition: transform 0.3s ease;
    &.scrollDown {
      animation-name: scrollV Dwn;
      animation-duration: 10s;
      animation-fill-mode: forwards;
    }
    .headings {
      height: 80 * $s;
      display: flex;
      left: 124 * $s;
      position: relative;
      width: 1710 * $s;
      justify-content: space-between;
      .nav-button {
        box-sizing: content-box;
        font-family: TTNormsBold;
        font-size: 24 * $s;
        color: rgba(80,80,80,0.3);
        display: flex;
        position: relative;
        align-items: center;
        .focus_bg {
          position: absolute;
          left: -40 * $s;
          top: 0 * $s;
          width: calc(100% + #{80 * $s});
          height: calc(100%);
          border-radius: 10 * $s;
        }
        span {
          position: relative;
          z-index: 222;
        }
        &.selected {
          .focus_bg {
            background: white;
          }
          span {
            color: rgba(80,80,80,1)!important;
          }
        }
      }
      &.push-down {
        margin-top: 30 * $s;
        .nav-button{
          span {
            color: rgba(80,80,80,0.6);
            font-size: 30 * $s;
          }
        }
      }
    }
    .scroll_mask {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 225 * $s;
      background-image: url('/static/Images/home/scroll_mask.png');
      z-index: 2;
      &.push-down {
        top: -30 * $s;
      }
    }
    .content-wrapper {
      position: relative;
      width: 100%;
      top: 20 * $s;
      height: 970 * $s;
      // overflow: hidden;
      .list {
        position: absolute;
        top: 0;
        height: 100%;
        width: auto;
      }
      .contentlist {
        position: relative;
        margin-top: 30 * $s;
      }
    }
    @keyframes scrollVDwn {
    to {transform: translateY(-100%);}
    }
  }
</style>
